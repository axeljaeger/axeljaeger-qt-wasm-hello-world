name: Build and Deploy Qt WebAssembly to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Install Qt Desktop (required for WebAssembly)
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        host: 'linux'
        target: 'desktop'
        arch: 'gcc_64'
        cache: true
    
    - name: Install Qt for WebAssembly
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.5.3'
        host: 'linux'
        target: 'desktop'
        arch: 'wasm_singlethread'
        cache: true
    
    - name: Setup Emscripten
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: '3.1.25'
        actions-cache-folder: 'emsdk-cache'
    
    - name: Verify installations
      run: |
        echo "Qt version:"
        qmake --version
        echo "Emscripten version:"
        emcc --version
        echo "CMake version:"
        cmake --version
    
    - name: Configure CMake for WebAssembly
      run: |
        mkdir -p build
        cd build
        qt-cmake .. \
          -DCMAKE_BUILD_TYPE=Release \
          -DQT_HOST_PATH=/opt/hostedtoolcache/Qt/6.5.3/gcc_64 \
          -DQT_QMAKE_EXECUTABLE=${Qt6_DIR}/../../bin/qmake
    
    - name: Build WebAssembly
      run: |
        cd build
        cmake --build . --parallel
    
    - name: List build output
      run: |
        echo "Build directory contents:"
        find build -type f -name "*.html" -o -name "*.js" -o -name "*.wasm" | sort
        echo ""
        echo "All build files:"
        ls -laR build/
    
    - name: Prepare deployment files
      run: |
        mkdir -p deploy
        # Copy WebAssembly output files
        cp build/HelloWorldWasm.html deploy/index.html || cp build/HelloWorldWasm.html deploy/HelloWorldWasm.html
        cp build/HelloWorldWasm.js deploy/ || true
        cp build/HelloWorldWasm.wasm deploy/ || true
        cp build/qtloader.js deploy/ || true
        cp build/qtlogo.svg deploy/ || true
        
        # If index.html wasn't created, create a simple one
        if [ ! -f deploy/index.html ]; then
          cat > deploy/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>Qt WebAssembly Hello World</title>
            <script src="qtloader.js"></script>
            <style>
                body {
                    margin: 0;
                    padding: 0;
                    font-family: Arial, sans-serif;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    min-height: 100vh;
                }
                #container {
                    background: white;
                    border-radius: 10px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    padding: 20px;
                }
                #status {
                    text-align: center;
                    color: #333;
                    margin-bottom: 20px;
                }
            </style>
        </head>
        <body>
            <div id="container">
                <div id="status">Loading Qt WebAssembly Application...</div>
                <div id="screen"></div>
            </div>
            <script>
                var statusElement = document.getElementById('status');
                var containerElement = document.getElementById('container');
                var config = {
                    containerElements: [document.getElementById('screen')],
                    statusChanged: function(status) {
                        if (status === 'loaded') {
                            statusElement.innerText = 'Application Loaded!';
                            setTimeout(function() {
                                statusElement.style.display = 'none';
                            }, 2000);
                        } else if (status === 'loading') {
                            statusElement.innerText = 'Loading...';
                        } else {
                            statusElement.innerText = status;
                        }
                    }
                };
                
                // Load the Qt application
                qtLoad(config, 'HelloWorldWasm');
            </script>
        </body>
        </html>
        EOF
        fi
        
        ls -la deploy/
    
    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./deploy
  
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
